<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Cam AI Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">üé• Smart Cam AI Manager</h2>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery" type="button">L·ªãch s·ª≠ Khu√¥n m·∫∑t</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="cam-tab" data-bs-toggle="tab" data-bs-target="#cameras" type="button">C·∫•u h√¨nh Camera</button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="myTabContent">
            <!-- Gallery Tab -->
            <div class="tab-pane fade show active" id="gallery">
                <div class="row mb-3">
                    <div class="col-md-4 mb-2">
                        <input type="date" id="filterDate" class="form-control" onchange="loadFaces()">
                    </div>
                    <div class="col-md-4 mb-2">
                        <select id="filterCam" class="form-control" onchange="loadFaces()">
                            <option value="">T·∫•t c·∫£ Camera</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-primary w-100" onclick="loadFaces()">üîÑ L√†m m·ªõi ·∫£nh</button>
                    </div>
                </div>
                <div id="faceList" class="row g-3"></div>
            </div>

            <!-- Camera Config Tab -->
            <div class="tab-pane fade" id="cameras">
                <div class="card p-3 mb-3">
                    <h5>Th√™m Camera M·ªõi</h5>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="text" id="newCamName" class="form-control" placeholder="T√™n (VD: Cam C·ªïng)">
                        </div>
                        <div class="col-md-6">
                            <input type="text" id="newCamUrl" class="form-control" placeholder="RTSP URL (rtsp://...)">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success w-100" onclick="addCamera()">‚ûï Th√™m</button>
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">L∆∞u √Ω: RTSP URL ph·∫£i ch√≠nh x√°c. V√≠ d·ª•: rtsp://admin:pass@192.168.1.10:554/...</small>
                </div>
                <h5>Danh s√°ch Camera ƒëang ch·∫°y</h5>
                <ul class="list-group" id="camList"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // S·ª¨ D·ª§NG ƒê∆Ø·ªúNG D·∫™N T∆Ø∆†NG ƒê·ªêI (QUAN TR·ªåNG CHO INGRESS)
        const API_BASE = './api'; 

        async function loadCameras() {
            try {
                const res = await fetch(`${API_BASE}/cameras`);
                if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch camera");
                
                const data = await res.json();
                const list = document.getElementById('camList');
                const select = document.getElementById('filterCam');
                
                list.innerHTML = '';
                // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n
                select.innerHTML = '<option value="">T·∫•t c·∫£ Camera</option>';

                if (data.length === 0) {
                    list.innerHTML = '<li class="list-group-item text-muted">Ch∆∞a c√≥ camera n√†o. H√£y th√™m m·ªõi!</li>';
                }

                data.forEach(cam => {
                    // cam: [id, name, rtsp_url, active]
                    list.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div style="overflow: hidden; text-overflow: ellipsis;">
                                <strong>${cam[1]}</strong><br>
                                <small class="text-muted" style="font-size:0.8em">${cam[2]}</small>
                            </div>
                            <button class="btn btn-danger btn-sm ms-2" onclick="delCamera(${cam[0]})">X√≥a</button>
                        </li>
                    `;
                    select.innerHTML += `<option value="${cam[1]}">${cam[1]}</option>`;
                });
            } catch (err) {
                console.error(err);
                alert("L·ªói t·∫£i camera: " + err.message);
            }
        }

        async function addCamera() {
            const name = document.getElementById('newCamName').value.trim();
            const url = document.getElementById('newCamUrl').value.trim();
            
            if(!name || !url) return alert("Vui l√≤ng nh·∫≠p t√™n v√† ƒë∆∞·ªùng d·∫´n RTSP!");
            
            try {
                const res = await fetch(`${API_BASE}/cameras`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, url})
                });
                
                if (!res.ok) throw new Error("L·ªói Server khi th√™m camera");
                
                document.getElementById('newCamName').value = '';
                document.getElementById('newCamUrl').value = '';
                alert("ƒê√£ th√™m camera th√†nh c√¥ng!");
                loadCameras();
            } catch (err) {
                console.error(err);
                alert("Kh√¥ng th·ªÉ th√™m camera: " + err.message);
            }
        }

        async function delCamera(id) {
            if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a camera n√†y?")) return;
            try {
                await fetch(`${API_BASE}/cameras?id=${id}`, { method: 'DELETE' });
                loadCameras();
            } catch (err) {
                alert("L·ªói khi x√≥a: " + err.message);
            }
        }

        async function loadFaces() {
            const date = document.getElementById('filterDate').value;
            const cam = document.getElementById('filterCam').value;
            let url = `${API_BASE}/faces?`;
            if(date) url += `date=${date}&`;
            if(cam) url += `cam=${cam}`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i ·∫£nh");
                const data = await res.json();
                const container = document.getElementById('faceList');
                container.innerHTML = '';

                if(data.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted col-12">Kh√¥ng t√¨m th·∫•y khu√¥n m·∫∑t n√†o.</p>';
                    return;
                }

                data.forEach(face => {
                    // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi cho ·∫£nh
                    container.innerHTML += `
                        <div class="col-6 col-md-3 col-lg-2">
                            <div class="card h-100 shadow-sm">
                                <img src="./faces/${face[2]}" class="card-img-top face-img" alt="Face" style="height:150px; object-fit:cover;">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-0" style="font-size:0.9rem">${face[1]}</h6>
                                    <small class="text-muted" style="font-size:0.75rem">${new Date(face[3]).toLocaleString('vi-VN')}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (err) {
                console.error(err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCameras();
            loadFaces();
        });
    </script>
</body>
</html>
